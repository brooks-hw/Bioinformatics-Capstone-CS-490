<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DNA Workflow Pipeline</title>
  <style>
    .trim-list {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .trim-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 4px;
    }

    .trim-left {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      color: #00584d;
      min-width: 180px;
    }

    .trim-left input[type="checkbox"] {
      transform: scale(1.25);
      accent-color: #00796b;
    }

    .trim-right {
      display: flex;
      align-items: center;
      gap: 10px 18px;
      flex-wrap: wrap;
    }

    .trim-right label {
      font-size: 0.9rem;
      color: #004d40;
    }

    .trim-right input[type="number"] {
      width: 70px;
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 0.95rem;
      background: #ffffff;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .trim-right input[type="number"]:focus {
      border-color: #00796b;
      box-shadow: 0 0 4px rgba(0,121,107,0.25);
    }

    .trim-divider {
      height: 1px;
      background: #e1ecea;
      margin: 2px 0;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f7fbfd;
      color: #333;
      margin: 0;
      display: flex;
      }
      .file-list {
        margin: 12px auto 0;
        max-width: 700px;
        text-align: left;
      }
    .file-pill {
        display: inline-block;
        margin: 4px 6px 0 0;
        padding: 6px 10px;
        border-radius: 14px;
        background: #eaf6f4;
        color: #00584d;
        font-size: 0.9rem;
        border: 1px solid #cfe7e3;
      }
      .stats-table {
        margin: 25px auto;
        border-collapse: collapse;
        width: 80%;
        max-width: 700px;
        background: #ffffff;
        box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        border-radius: 8px;
        overflow: hidden;
      }
      .stats-table th {
        background-color: #00695c;
        color: white;
        text-align: left;
        padding: 10px;
      }
      .stats-table td {
        border-bottom: 1px solid #ddd;
        padding: 10px;
      }
      .stats-table tr:nth-child(even) {
        background-color: #f9f9f9;
      }

    /* Sidebar */
    .sidebar {
      width: 210px;
      background-color: #00695c;
      color: white;
      height: 100vh;
      padding-top: 30px;
      position: fixed;
      left: 0;
      top: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .sidebar h2 {
      margin-bottom: 30px;
      font-size: 1.3rem;
      letter-spacing: 0.5px;
    }

    .sidebar a {
      display: block;
      width: 80%;
      text-align: center;
      color: white;
      padding: 12px;
      margin: 6px 0;
      border-radius: 8px;
      text-decoration: none;
      transition: background-color 0.3s ease;
    }

    .sidebar a:hover,
    .sidebar a.active {
      background-color: #004d40;
    }

    /* Content */
    .content {
      margin-left: 230px;
      padding: 40px 60px;
      width: calc(100% - 230px);
      text-align: center;
    }

    h1 {
      font-size: 2.2rem;
      color: #004d40;
      margin-bottom: 40px;
    }

    h3 {
      color: #00695c;
      font-size: 1.4rem;
      margin-bottom: 25px;
    }

    .page {
      display: none;
      animation: fadeIn 0.4s ease;
    }

    .page.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .module {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
      padding: 35px;
      max-width: 850px;
      margin: 0 auto 50px;
      transition: box-shadow 0.3s ease;
    }
    /* Trimmomatic Customization Form */
  .options {
    text-align: left;
    background: #f8fcfb;
    border: 1px solid #d8eae7;
    border-radius: 12px;
    padding: 25px 30px;
    margin: 30px auto;
    max-width: 600px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .options h4 {
    text-align: center;
    color: #004d40;
    margin-bottom: 20px;
    font-size: 1.1rem;
  }

  .options label {
    font-weight: 600;
    color: #00584d;
  }

  .options select,
  .options input[type="number"] {
    margin-top: 6px;
    margin-bottom: 15px;
    width: 100%;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 0.95rem;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
  }

  .options select:focus,
  .options input[type="number"]:focus {
    outline: none;
    border-color: #00796b;
    box-shadow: 0 0 6px rgba(0, 121, 107, 0.25);
  }

  .options input[type="checkbox"] {
    transform: scale(1.2);
    margin-right: 8px;
    accent-color: #00796b;
  }

  .options div {
    line-height: 1.8;
  }

  button[type="button"],
  button[type="submit"] {
    margin: 10px 8px;
    padding: 12px 28px;
    border-radius: 8px;
    font-weight: 600;
    letter-spacing: 0.3px;
  }

  #cmdPreview {
    margin-top: 30px;
    background: #f2f7f6;
    border: 1px solid #d1e7e2;
    border-radius: 12px;
    padding: 20px;
    max-width: 700px;
    margin-left: auto;
    margin-right: auto;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
  }

  #cmdPreview h4 {
    color: #004d40;
    font-size: 1.05rem;
    margin-bottom: 10px;
  }

  #cmdText {
    display: block;
    padding: 10px;
    font-family: monospace;
    background: #eaf6f4;
    color: #00695c;
    border-radius: 8px;
    word-wrap: break-word;
    text-align: left;
  }


      .module:hover {
        box-shadow: 0 8px 22px rgba(0, 0, 0, 0.12);
      }

      .drop-zone {
        border: 2px dashed #00796b;
        border-radius: 12px;
        padding: 35px;
        background-color: #e0f2f1;
        color: #004d40;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.3s ease;
        margin-bottom: 25px;
      }

    .drop-zone:hover {
      background-color: #d1efea;
    }

    button {
      background-color: #00796b;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      padding: 12px 28px;
      cursor: pointer;
      margin-top: 10px;
      transition: background-color 0.3s ease, transform 0.1s ease;
    }

    button:hover {
      background-color: #005f55;
      transform: translateY(-1px);
    }

    select {
      margin-top: 15px;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background-color: #f9f9f9;
      font-size: 1rem;
      color: #333;
      transition: border-color 0.2s ease;
    }

    select:hover {
      border-color: #00796b;
    }

    /* Slideshow */
    .slideshow-container {
      position: relative;
      max-width: 700px;
      margin: 30px auto;
    }

    .slide img {
      width: 100%;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      cursor: pointer;
    }

    .prev, .next {
      cursor: pointer;
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      padding: 16px;
      color: white;
      font-weight: bold;
      font-size: 20px;
      background: rgba(0,0,0,0.4);
      border-radius: 50%;
      transition: background 0.3s;
    }

    .prev:hover, .next:hover {
      background-color: rgba(0,0,0,0.7);
    }

    .prev { left: -50px; }
    .next { right: -50px; }

    .dots {
      text-align: center;
      margin-top: 15px;
    }

    .dot {
      cursor: pointer;
      height: 12px;
      width: 12px;
      margin: 0 4px;
      background-color: #bbb;
      border-radius: 50%;
      display: inline-block;
      transition: background-color 0.3s ease;
    }

    .dot.active, .dot:hover {
      background-color: #00796b;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 1000;
      padding-top: 60px;
    }

    .modal-content {
      margin: auto;
      display: block;
      max-width: 90%;
      max-height: 80vh;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }

    .modal-caption {
      text-align: center;
      color: #f1f1f1;
      font-size: 18px;
      margin-top: 20px;
    }

    .close {
      position: absolute;
      top: 20px;
      right: 40px;
      color: #fff;
      font-size: 40px;
      cursor: pointer;
    }

    .close:hover {
      color: #bbb;
    }


  </style>

  
<!-- === Help Button Styles (Online Manuals) === -->
<style>
  :root {
    --help-green: #116530;     /* dark green */
    --help-green-hover: #0d4d26;
    --help-text: #ffffff;
    --help-shadow: rgba(0,0,0,0.2);
  }
  .help-container {
    position: fixed;
    top: 16px;
    right: 16px;
    z-index: 9999;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  }
  .help-btn {
    background: var(--help-green);
    color: var(--help-text);
    border: none;
    border-radius: 8px;
    padding: 10px 14px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 2px 6px var(--help-shadow);
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  .help-btn:hover,
  .help-btn:focus { background: var(--help-green-hover); outline: none; }

  .help-caret {
    border: solid var(--help-text);
    border-width: 0 2px 2px 0;
    display: inline-block;
    padding: 3px;
    transform: rotate(45deg);
    transition: transform 160ms ease;
  }
  .help-btn[aria-expanded="true"] .help-caret { transform: rotate(-135deg); }

  .help-menu {
    position: absolute;
    right: 0;
    margin-top: 8px;
    background: #ffffff;
    border: 1px solid #e6e6e6;
    border-radius: 10px;
    min-width: 280px;
    box-shadow: 0 8px 18px var(--help-shadow);
    padding: 8px 0;
    display: none; /* hidden by default */
  }
  .help-menu[data-open="true"] { display: block; }

  .help-item {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 10px;
    padding: 10px 14px;
    color: #222;
    text-decoration: none;
    line-height: 1.35;
    align-items: center;
  }
  .help-item:hover, .help-item:focus { background: #f5f7f5; outline: none; }
  .help-item .tag {
    font-size: 12px;
    font-weight: 700;
    color: #116530;
    background: #eaf4ee;
    border-radius: 6px;
    padding: 2px 6px;
  }
  .help-item small { color: #666; }
  @media (max-width: 480px) {
    .help-container { top: 10px; right: 10px; }
    .help-menu { min-width: 240px; }
  }
</style>

<!-- === Help Button + Menu === -->
<div class="help-container">
  <button class="help-btn" id="helpBtn" aria-haspopup="true" aria-expanded="false" aria-controls="helpMenu">
    Help
    <span class="help-caret" aria-hidden="true"></span>
  </button>

  <div class="help-menu" id="helpMenu" role="menu" aria-label="Tool manuals"></div>
</div>

<!-- === online manual URLs & toggle === -->
<script>
  (function () {
    // if we need to change or add a URL here, menu updates automatically.
    const MANUALS = [
      {
        name: "FastQC Manual",
        tag: "QC",
        href: "https://mugenomicscore.missouri.edu/PDF/FastQC_Manual.pdf"
      },
      {
        name: "Trimmomatic Manual (PDF)",
        tag: "Trim",
        href: "http://www.usadellab.org/cms/uploads/supplementary/Trimmomatic/TrimmomaticManual_V0.32.pdf"
      },
      {
        name: "Trinity Documentation",
        tag: "Assembly",
        href: "https://github.com/trinityrnaseq/trinityrnaseq/wiki"
      },
      {
        name: "BWA Manual (BWA-MEM)",
        tag: "Align",
        href: "https://bio-bwa.sourceforge.net/bwa.shtml"
      },
      {
        name: "DESeq2 Manual / Vignettes",
        tag: "DE",
        href: "https://bioc.r-universe.dev/DESeq2/doc/manual.html"
      }
    ];

    const btn = document.getElementById('helpBtn');
    const menu = document.getElementById('helpMenu');

    // Build the menu items dynamically
    MANUALS.forEach(m => {
      const a = document.createElement('a');
      a.className = 'help-item';
      a.setAttribute('role', 'menuitem');
      a.setAttribute('href', m.href);
      a.setAttribute('target', '_blank');
      a.setAttribute('rel', 'noopener');
      a.innerHTML = `
        <strong>${m.name}</strong>
        <small>Opens documentation site</small>
        <span class="tag">${m.tag}</span>
      `;
      menu.appendChild(a);
    });

    function setOpen(open) {
      btn.setAttribute('aria-expanded', String(open));
      menu.setAttribute('data-open', String(open));
    }

    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = btn.getAttribute('aria-expanded') === 'true';
      setOpen(!isOpen);
    });

    // Close when clicking outside
    document.addEventListener('click', () => setOpen(false));

    // Keyboard accessibility
    btn.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') setOpen(false);
      if (e.key === 'ArrowDown') setOpen(true);
    });
  })();
</script>
</head>

<body>
  <div class="sidebar"> <h2>DNA Tools</h2> <a href="#" class="active" onclick="showPage('fastqc', this)">FastQC</a> <a href="#" onclick="showPage('trimmomatic', this)">Trimmomatic</a> <a href="#" onclick="showPage('trinity', this)">Trinity</a> <a href="#" onclick="showPage('bwt', this)">Burrows–Wheeler</a> <a href="#" onclick="showPage('deseq2', this)">DESeq2</a> </div>
  
  <div class="content">
    <h1>Data Analysis Pipeline</h1>

    <!-- FastQC -->
    <div id="fastqc" class="page active module">
      <h3>1. Upload DNA Data (FastQC)</h3>
      <form action="/run-fastqc" method="post" enctype="multipart/form-data" onsubmit="enableLoading()">
        <div class="drop-zone" id="fastqcDropZone">
          <p>Drag & drop your FASTQ files here, or click to select</p>
          <input type="file" id="dnaFiles" name="dnaFiles" accept=".fastq,.gz" multiple required hidden>
        </div>
        <button type="submit">Upload & Run FastQC</button>
        <button type="button" onclick="
          showCommandPreview(
            'FASTQC',
            'fastqc --outdir fastqc_output ' +
            [...document.getElementById('dnaFiles').files].map(f => f.name).join(' ')
          );
        ">
          Preview FastQC Command
        </button>
        <div id="FASTQC_cmdPreview" 
            style="margin-top:25px; text-align:center; background:#f0f0f0; border-radius:10px; padding:15px; display:none;">
          <h4 style="color:#004d40;">Generated Command</h4>
          <code id="FASTQC_cmdText" style="font-size:0.9rem; color:#004d40;"></code>
        </div>




      </form>

      {% if fastqc_reports %}
        <h4>View FastQC Reports</h4>
        <form action="/view-report" method="get">
          <select name="file" onchange="this.form.submit()">
            {% for report in fastqc_reports %}
              <option value="{{ report }}" {% if report == selected_report %}selected{% endif %}>
                {{ report }}
              </option>
            {% endfor %}
          </select>
        </form>
      {% endif %}

      {% if images %}
        <script>
          window.onload = () => {
            showToast("FastQC Completed Successfully — Output saved in /fastqc_output");
          };
        </script>

        <div class="slideshow-container">
          {% for img in images %}
            <div class="slide">
              <img src="{{ img }}" alt="FastQC report image" onclick="openModal(this)" />
            </div>
          {% endfor %}
          <a class="prev" onclick="plusSlides(-1)">&#10094;</a>
          <a class="next" onclick="plusSlides(1)">&#10095;</a>
        </div>
        <div class="dots">
          {% for img in images %}
            <span class="dot" onclick="currentSlide('{{ loop.index }}')"></span>
          {% endfor %}
        </div>
      {% else %}
        <p>No images yet. Upload a file to run FastQC.</p>
      {% endif %}
    </div>

    <!-- Trimmomatic -->
<div id="trimmomatic" class="page module">
  <h3>2. Trim Reads with Trimmomatic</h3>

  <form action="/run-trimmomatic" method="post" enctype="multipart/form-data" id="trimmomaticForm" onsubmit="enableLoading()">
    
    <!-- File Upload -->
    <div class="drop-zone" id="trimDropZone">
      <p>Drag & drop your FASTQ file(s) here, or click to select</p>
      <input type="file" id="trimFiles" name="trimFiles" accept=".fastq,.gz" multiple required hidden>
    </div>

    <!-- Options Panel -->
    <div class="options" style="text-align:left; max-width:600px; margin:0 auto;">
      <h4 style="text-align:center; color:#004d40;">Customization Options</h4>

      <label><b>Mode:</b></label>
      <select name="mode" id="mode">
        <option value="SE">Single-End (SE)</option>
        <option value="PE">Paired-End (PE)</option>
      </select>
      <br><br>

      <label><b>Threads:</b></label>
      <input type="number" id="threads" name="threads" value="4" min="1" max="32" style="width:70px;">
      <br><br>

      <label><b>Phred Encoding:</b></label>
      <select name="phred" id="phred">
        <option value="-phred33">-phred33</option>
        <option value="-phred64">-phred64</option>
      </select>

    </div>

    <!-- Sleek Trimming Steps -->
    <label style="margin-top:25px; display:block;"><b>Trimming Steps:</b></label>

    <div class="trim-list">

      <!-- SLIDINGWINDOW -->
      <div class="trim-row">
        <label class="trim-left">
          <input type="checkbox" id="sliding" name="sliding" checked>
          <span>SLIDINGWINDOW</span>
        </label>

        <div class="trim-right">
          <label>window size:</label>
          <input type="number" id="sliding_window" name="sliding_window" min="1" max="50" value="4">

          <label>quality:</label>
          <input type="number" id="sliding_quality" name="sliding_quality" min="3" max="40" value="20">
        </div>
      </div>

      <div class="trim-divider"></div>

      <!-- MINLEN -->
      <div class="trim-row">
        <label class="trim-left">
          <input type="checkbox" id="minlen" name="minlen" checked>
          <span>MINLEN</span>
        </label>

        <div class="trim-right">
          <label>minimum length:</label>
          <input type="number" id="minlen_val" name="minlen_val" min="1" max="300" value="50">
        </div>
      </div>

      <div class="trim-divider"></div>

      <!-- CROP -->
      <div class="trim-row">
        <label class="trim-left">
          <input type="checkbox" id="crop" name="crop">
          <span>CROP</span>
        </label>

        <div class="trim-right">
          <label>max length:</label>
          <input type="number" id="crop_val" name="crop_val" min="1" max="300" value="100">
        </div>
      </div>

      <div class="trim-divider"></div>

      <!-- HEADCROP -->
      <div class="trim-row">
        <label class="trim-left">
          <input type="checkbox" id="headcrop" name="headcrop">
          <span>HEADCROP</span>
        </label>

        <div class="trim-right">
          <label>trim from start:</label>
          <input type="number" id="headcrop_val" name="headcrop_val" min="0" max="50" value="10">
        </div>
      </div>

    </div>

    <br>

    <!-- Buttons -->
    <button type="submit">Upload & Run Trimmomatic</button>

    <button type="button" onclick="
      const trimFilesList = [...document.getElementById('trimFiles').files];
      const mode = document.getElementById('mode').value;
      const threads = document.getElementById('threads').value;
      const phred = document.getElementById('phred').value;

      let steps = [];

      if (document.getElementById('sliding').checked) {
        const win = document.getElementById('sliding_window').value;
        const qual = document.getElementById('sliding_quality').value;
        steps.push(`SLIDINGWINDOW:${win}:${qual}`);
      }

      if (document.getElementById('minlen').checked) {
        const val = document.getElementById('minlen_val').value;
        steps.push(`MINLEN:${val}`);
      }

      if (document.getElementById('crop').checked) {
        const val = document.getElementById('crop_val').value;
        steps.push(`CROP:${val}`);
      }

      if (document.getElementById('headcrop').checked) {
        const val = document.getElementById('headcrop_val').value;
        steps.push(`HEADCROP:${val}`);
      }

      showCommandPreview(
        'TRIM',
        'java -jar trimmomatic.jar ' +
        mode + ' -threads ' + threads + ' ' + phred + ' ' +
        (trimFilesList[0] ? trimFilesList[0].name : 'input.fastq') + ' ' +
        'output_trimmed.fastq ' +
        steps.join(' ')
      );
    "
    style="margin: 10px 8px; padding: 12px 28px; border-radius: 8px; font-weight: 600;">
      Preview Command
    </button>

  </form>

  <!-- Preview Box -->
  <div id="TRIM_cmdPreview"
       style="margin-top:25px; text-align:center; background:#f0f0f0;
              border-radius:10px; padding:15px; display:none;">
    <h4 style="color:#004d40;">Generated Command</h4>
    <code id="TRIM_cmdText"
          style="font-size:0.9rem; color:#004d40; word-wrap:break-word;">
    </code>
  </div>

  {% if trim_summary %}
  <script>
    window.onload = () =>
      showToast('Trimmomatic Completed Successfully — Output saved in /trimmomatic_output');
  </script>
  <div class="tool-complete">
    Trimmomatic completed successfully.
  </div>
  <div class="results">
    <h4>Trimmomatic Results</h4>
    <pre>{{ trim_summary }}</pre>
  </div>

  {% else %}
    <p>No trimming done yet. Upload a file to run Trimmomatic.</p>
  {% endif %}
</div>

    

   <!-- Trinity -->
   <div id="trinity" class="page module">
    <h3>3. Transcriptome Assembly (Trinity)</h3>
    <form action="/run-trinity" method="post" enctype="multipart/form-data" onsubmit="enableLoading()">
      <div class="drop-zone" id="trinityDropZone">
        <p>Drag & drop your input FASTQ files here, or click to select</p>
        <input type="file" id="trinityFiles" name="trinityFiles" accept=".fastq,.gz" multiple required hidden>
      </div>
      <button type="submit">Upload & Run Trinity</button>
      <button type="button" onclick="
        showCommandPreview(
          'TRINITY',
          'Trinity --seqType fq --CPU 4 --max_memory 8G --output trinity_output ' +
          [...document.getElementById('trinityFiles').files].map(f => f.name).join(' ')
        );
      " 
      style="margin: 10px 8px; padding: 12px 28px; border-radius: 8px; font-weight: 600;">
        Preview Trinity Command
      </button>

      <div id="TRINITY_cmdPreview"
          style="margin-top:25px; text-align:center; background:#f0f0f0;
                  border-radius:10px; padding:15px; display:none;">
        <h4 style="color:#004d40;">Generated Command</h4>
        <code id="TRINITY_cmdText"
              style="font-size:0.9rem; color:#004d40; word-wrap:break-word;">
        </code>
      </div>


    </form>

    {% if trinity_summary %}
      {% if trinity_success %}
        <script>
          window.onload = () => {
            showToast("Trinity Completed Successfully — Output saved in /trinity_output");
          };
        </script>
      {% else %}
        <script>
          window.onload = () => {
            showToast("Trinity Failed — Check the output section for details");
          };
        </script>
      {% endif %}
  
      <div class="results">
        <h4>Trinity Assembly Results</h4>
        <pre>{{ trinity_summary }}</pre>
      </div>
    {% else %}
      <p>No Trinity assembly has been run yet. Upload files to start assembly.</p>
    {% endif %}
  </div>
    <!-- BURROWS–WHEELER TRANSFORM -->
    <div id="bwt" class="page module">
      <h3>4. Sequence Alignment (Burrows–Wheeler)</h3>

      <form action="/run-bwt" method="post" enctype="multipart/form-data" id="bwtForm" onsubmit="enableLoading()">
        <!-- Multi-file drag & drop -->
        <div class="drop-zone" id="bwtDropZone" data-accept=".fastq,.fq,.fasta,.fa,.gz">
          <p>Drag & drop FASTQ (reads) and one FASTA (reference) here, or click to select</p>
          <input
            type="file"
            id="bwtFiles"
            name="bwtFiles"
            multiple
            required
            hidden
            accept=".fastq,.fq,.fasta,.fa,.gz"
          >
        </div>

        <!-- Live file list -->
        <div id="bwtFileList" class="file-list"></div>

        <!-- Optional SAMtools toggle -->
        <label style="display:inline-flex; align-items:center; gap:.5rem; margin-top:10px;">
          <input type="checkbox" name="run_samtools" checked>
          Run SAMtools automatically (convert, sort, and index)
        </label>

        <br>
        <button type="submit">Run BWA Alignment</button>
        <button type="button" onclick="
        const files = [...document.getElementById('bwtFiles').files];
        const fasta = files.find(f => f.name.match(/\.fa$|\.fasta$/));
        const fastq = files.find(f => f.name.match(/\.fq$|\.fastq$|\.gz$/));

        showCommandPreview(
          'BWA',
          'bwa mem ' +
          (fasta ? fasta.name : 'reference.fasta') + ' ' +
          (fastq ? fastq.name : 'reads.fastq') +
          ' > alignment.sam'
        );
      "
      style='margin: 10px 8px; padding: 12px 28px; border-radius: 8px; font-weight: 600;'>
        Preview BWA Command
      </button>

      <div id="BWA_cmdPreview"
          style="margin-top:25px; text-align:center; background:#f0f0f0;
                  border-radius:10px; padding:15px; display:none;">
        <h4 style="color:#004d40;">Generated Command</h4>
        <code id="BWA_cmdText"
              style="font-size:0.9rem; color:#004d40; word-wrap:break-word;">
        </code>
      </div>

      </form>

      {% if bwt_summary %}
        <script>
          window.onload = () => {
            showToast("BWT Completed Successfully — Output saved in /fastqc_output");
          };
        </script>
        <div class="results" style="margin-top:20px; text-align:left;">
          <h4>BWT Alignment Results</h4>
          <pre>{{ bwt_summary }}</pre>
        </div>
      {% else %}
        <p>No alignment performed yet. Upload files to run the Burrows–Wheeler Transform alignment.</p>
      {% endif %}
    </div>


    <!-- DESEQ2 -->
<div id="deseq2" class="page module">
  <h3>5. Differential Expression Analysis (DESeq2)</h3>

  <form action="/run-deseq2" method="post" enctype="multipart/form-data" onsubmit="enableLoading()">
    <div class="drop-zone" id="deseqDropZone">
      <p>Upload count matrix (CSV/TSV) and sample metadata</p>
      <input type="file" id="deseqFiles" name="deseqFiles" accept=".csv,.tsv" multiple required hidden>
    </div>
    <button type="submit">Run DESeq2 Analysis</button>
    <button type="button" onclick="
      const deseqFiles = [...document.getElementById('deseqFiles').files];

      showCommandPreview(
        'DESEQ',
        'Rscript run_deseq2.R ' +
        (deseqFiles[0] ? deseqFiles[0].name : 'count_matrix.csv') + ' ' +
        (deseqFiles[1] ? deseqFiles[1].name : 'metadata.csv') +
        ' deseq2_output'
      );
    "
    style='margin: 10px 8px; padding: 12px 28px; border-radius: 8px; font-weight: 600;'>
      Preview DESeq2 Command
    </button>

  </form>

  <div id="DESEQ_cmdPreview"
       style="margin-top:25px; text-align:center; background:#f0f0f0;
              border-radius:10px; padding:15px; display:none;">
    <h4 style="color:#004d40;">Generated Command</h4>
    <code id="DESEQ_cmdText"
          style="font-size:0.9rem; color:#004d40; word-wrap:break-word;">
    </code>
  </div>

  {% if deseq_summary %}
    <script>
      window.onload = () =>
        showToast("DESeq2 Completed Successfully — Output saved in /deseq2_output");
    </script>

    <div class="results">
      <h4>DESeq2 Analysis Results</h4>
      <pre>{{ deseq_summary }}</pre>
    </div>

  {% else %}
    <p>No DESeq2 analysis yet. Upload input files to start differential expression analysis.</p>
  {% endif %}
</div>


  <!-- Modal -->
  <div id="imgModal" class="modal">
    <span class="close" onclick="closeModal()">&times;</span>
    <img class="modal-content" id="modalImage" />
    <div id="modalCaption" class="modal-caption"></div>
  </div>

  <script>
   function showCommandPreview(toolId, cmdText) {
      const box = document.getElementById(toolId + "_cmdPreview");
      const text = document.getElementById(toolId + "_cmdText");

      // If already visible → hide it
      if (box.style.display === "block") {
        box.style.display = "none";
        return;
      }

      // If hidden → show it
      text.textContent = cmdText;
      box.style.display = "block";
      box.scrollIntoView({ behavior: "smooth" });
    }




    let slideIndex = 1;
    document.addEventListener("DOMContentLoaded", () => {
      showSlides(slideIndex);
      setupDropZone("fastqcDropZone", "dnaFiles");
      setupDropZone("trimDropZone", "trimFiles");
      setupDropZone("trinityDropZone", "trinityFiles");
      setupDropZone("bwtDropZone", "bwtFiles", "bwtFileList");        
    setupDropZone("deseqDropZone", "deseqFiles");  
    });

    function plusSlides(n) { showSlides(slideIndex += n); }
    function currentSlide(n) { showSlides(slideIndex = n); }

    function showSlides(n) {
      const slides = document.getElementsByClassName("slide");
      const dots = document.getElementsByClassName("dot");
      if (!slides.length) return;
      if (n > slides.length) slideIndex = 1;
      if (n < 1) slideIndex = slides.length;
      for (let s of slides) s.style.display = "none";
      for (let d of dots) d.classList.remove("active");
      slides[slideIndex - 1].style.display = "block";
      dots[slideIndex - 1]?.classList.add("active");
    }
    function enableLoading() {
      document.getElementById("loadingOverlay").style.display = "block";
    }

    function showPage(pageId, element) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
      element.classList.add('active');
    }

    function openModal(imgElement) {
      const modal = document.getElementById("imgModal");
      const modalImg = document.getElementById("modalImage");
      const captionText = document.getElementById("modalCaption");
      modal.style.display = "block";
      modalImg.src = imgElement.src;
      captionText.textContent = imgElement.alt || "";
    }

    function closeModal() {
      document.getElementById("imgModal").style.display = "none";
    }

    function setupDropZone(dropZoneId, inputId, listId) {
    const dropZone = document.getElementById(dropZoneId);
    const fileInput = document.getElementById(inputId);
    const listEl = listId ? document.getElementById(listId) : null;

    const renderList = () => {
      if (!listEl) return;
      listEl.innerHTML = "";
      [...fileInput.files].forEach(f => {
        const pill = document.createElement("span");
        pill.className = "file-pill";
        pill.textContent = f.name;
        listEl.appendChild(pill);
      });
    };

    const setHint = () => {
      const names = [...fileInput.files].map(f => f.name).join(", ");
      dropZone.querySelector("p").textContent = names ? `Selected: ${names}` :
        "Drag & drop FASTQ (reads) and one FASTA (reference) here, or click to select";
    };

    dropZone.addEventListener("click", () => fileInput.click());

    dropZone.addEventListener("dragover", e => {
      e.preventDefault();
      dropZone.classList.add("dragover");
    });
    dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));

    dropZone.addEventListener("drop", e => {
      e.preventDefault();
      dropZone.classList.remove("dragover");
      fileInput.files = e.dataTransfer.files;  // multi-file supported
      setHint();
      renderList();
    });

    fileInput.addEventListener("change", () => {
      setHint();
      renderList();
    });
  }


  function previewTrimmomaticCmd() {
    const mode = document.getElementById('mode').value;
    const threads = document.getElementById('threads').value;
    const phred = document.getElementById('phred').value;
    const steps = Array.from(document.querySelectorAll('input[name="steps"]:checked')).map(c => c.value);

    const base = [
      "java", "-jar", "trimmomatic.jar",
      mode, "-threads", threads, phred,
      "input.fastq", "output_trimmed.fastq"
    ];

    const cmd = base.concat(steps).join(" ");
    document.getElementById('cmdText').textContent = cmd;
    document.getElementById('cmdPreview').style.display = "block";
  }

  // --- Remember current tab between reloads ---
  document.addEventListener("DOMContentLoaded", () => {
    const lastPage = localStorage.getItem("activePage");
    if (lastPage) {
      showPage(lastPage, document.querySelector(`.sidebar a[onclick*="${lastPage}"]`));
    }
  });

// Modify showPage to store state
  function showPage(pageId, element) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));

    const page = document.getElementById(pageId);
    if (page) page.classList.add('active');
    if (element) element.classList.add('active');

    // Save the active page in localStorage
    localStorage.setItem("activePage", pageId);
  }


  </script>
  
</body>
</html>
